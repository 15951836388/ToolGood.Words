// ToolGood.Words.StringSearch.js
// 2020, Lin Zhijun, https://github.com/toolgood/ToolGood.Words
// Licensed under the Apache License 2.0
function StringSearch(){function u(){this.Layer=this.Index=0;this.End=!1;this.Char="";this.Results=[];this.m_values={};this.Parent=this.Failure=null;this.Add=function(c){if(null!=this.m_values[c])return this.m_values[c];var d=new u;d.Parent=this;d.Char=c;return this.m_values[c]=d};this.SetResults=function(c){0==this.End&&(this.End=!0);this.Results.push(c)}}function v(){this.End=!1;this.Results=[];this.m_values={};this.minflag=65535;this.maxflag=0;this.Add=function(c,d){this.minflag>c&&(this.minflag=c);this.maxflag<c&&(this.maxflag=c);this.m_values[c]=d};this.SetResults=function(c){0==this.End&&(this.End=!0);-1==this.Results.indexOf(c)&&this.Results.push(c)};this.HasKey=function(c){return void 0!=this.m_values[c]};this.TryGetValue=function(c){return this.minflag<=c&&this.maxflag>=c?this.m_values[c]:null}}var k=[],p=[];this.SetKeywords=function(c){p=c;c=new u;var d=[];d.push(c);for(var e={},a=0;a<p.length;a++){for(var f=p[a],b=c,r=0;r<f.length;r++)b=b.Add(f.charCodeAt(r)),0==b.Layer&&(b.Layer=r+1,e[b.Layer]||(e[b.Layer]=[]),e[b.Layer].push(b));b.SetResults(a)}for(var g in e)for(b=e[g],a=0;a<b.length;a++)d.push(b[a]);a=[];for(g in c.m_values)if(0!=c.m_values.hasOwnProperty(g)){b=c.m_values[g];b.Failure=c;for(var q in b.m_values)0!=b.m_values.hasOwnProperty(q)&&a.push(b.m_values[q])}for(;0!=a.length;){q=[];for(g in a)if(0!=a.hasOwnProperty(g)){b=a[g];e=b.Parent.Failure;for(f=b.Char;null!=e&&!e.m_values[f];)e=e.Failure;if(null==e)b.Failure=c;else{b.Failure=e.m_values[f];for(var h in b.Failure.Results)0!=b.Failure.Results.hasOwnProperty(h)&&b.SetResults(b.Failure.Results[h])}for(var l in b.m_values)0!=b.m_values.hasOwnProperty(l)&&q.push(b.m_values[l])}a=q}c.Failure=c;for(a=0;a<d.length;a++)d[a].Index=a;g=[];for(a=0;a<d.length;a++)g.push(new v);for(a=0;a<g.length;a++){h=d[a];l=g[a];for(var m in h.m_values)0!=h.m_values.hasOwnProperty(m)&&(b=h.m_values[m].Index,l.Add(m,g[b]));for(b=0;b<h.Results.length;b++)l.SetResults(h.Results[b]);if(h.Failure!=c){for(var n in h.Failure.m_values)0!=h.Failure.m_values.hasOwnProperty(n)&&0==l.HasKey(n)&&(b=h.Failure.m_values[n].Index,l.Add(n,g[b]));for(b=0;b<h.Failure.Results.length;b++)l.SetResults(h.Failure.Results[b])}}m=[];for(n=0;65535>n;n++)m.push(null);for(var t in g[0].m_values)0!=g[0].m_values.hasOwnProperty(t)&&(m[t]=g[0].m_values[t]);k=m};this.FindFirst=function(c){for(var d=null,e=0;e<c.length;e++){var a=c.charCodeAt(e);null==d?d=k[a]:(d=d.TryGetValue(a))||(d=k[a]);if(null!=d&&d.End)return p[d.Results[0]]}return null};this.FindAll=function(c){for(var d=null,e=[],a=0;a<c.length;a++){var f=c.charCodeAt(a);null==d?d=k[f]:(d=d.TryGetValue(f))||(d=k[f]);if(null!=d&&d.End)for(f=0;f<d.Results.length;f++)e.push(p[d.Results[f]])}return e};this.ContainsAny=function(c){for(var d=null,e=0;e<c.length;e++){var a=c.charCodeAt(e);null==d?d=k[a]:(d=d.TryGetValue(a))||(d=k[a]);if(null!=d&&d.End)return!0}return!1};this.Replace=function(c,d){d=void 0===d?"*":d;for(var e=c.split(""),a=null,f=0;f<c.length;f++){var b=c.charCodeAt(f);null==a?a=k[b]:(a=a.TryGetValue(b))||(a=k[b]);if(null!=a&&a.End)for(b=f+1-p[a.Results[0]].length;b<=f;b++)e[b]=d}return e.join("")}};